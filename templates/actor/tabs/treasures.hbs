<div class="hwfwm-card">
  <div class="hwfwm-card__title">Spirit Coins</div>

  {{!-- One-row, 6-across coins --}}
  <div class="hwfwm-coin-row6">
    <div class="hwfwm-coin-cell">
      <div class="hwfwm-res-label">Lesser</div>
      <input class="hwfwm-coin-input" type="number" name="system.treasures.coins.lesser" value="{{system.treasures.coins.lesser}}" min="0" step="1" />
    </div>

    <div class="hwfwm-coin-cell">
      <div class="hwfwm-res-label">Iron</div>
      <input class="hwfwm-coin-input" type="number" name="system.treasures.coins.iron" value="{{system.treasures.coins.iron}}" min="0" step="1" />
    </div>

    <div class="hwfwm-coin-cell">
      <div class="hwfwm-res-label">Bronze</div>
      <input class="hwfwm-coin-input" type="number" name="system.treasures.coins.bronze" value="{{system.treasures.coins.bronze}}" min="0" step="1" />
    </div>

    <div class="hwfwm-coin-cell">
      <div class="hwfwm-res-label">Silver</div>
      <input class="hwfwm-coin-input" type="number" name="system.treasures.coins.silver" value="{{system.treasures.coins.silver}}" min="0" step="1" />
    </div>

    <div class="hwfwm-coin-cell">
      <div class="hwfwm-res-label">Gold</div>
      <input class="hwfwm-coin-input" type="number" name="system.treasures.coins.gold" value="{{system.treasures.coins.gold}}" min="0" step="1" />
    </div>

    <div class="hwfwm-coin-cell">
      <div class="hwfwm-res-label">Diamond</div>
      <input class="hwfwm-coin-input" type="number" name="system.treasures.coins.diamond" value="{{system.treasures.coins.diamond}}" min="0" step="1" />
    </div>
  </div>

  {{!-- Subtabs always below coins --}}
  <nav class="hwfwm-tabs hwfwm-tabs--sub" data-group="treasures">
    <a class="hwfwm-tab {{#if (or (eq system._ui.treasuresSubTab "equipment") (not system._ui.treasuresSubTab))}}is-active{{/if}}" data-tab="equipment">Equipment</a>
    <a class="hwfwm-tab {{#if (eq system._ui.treasuresSubTab "inventory")}}is-active{{/if}}" data-tab="inventory">Inventory</a>
  </nav>

  {{!-- EQUIPMENT SUBTAB: shows only equipped equipment + readied consumables (derived, not duplicated) --}}
  <section class="tab" data-group="treasures" data-tab="equipment">

    {{!-- Equipped Equipment --}}
    <div class="hwfwm-res-separator">Equipped Equipment</div>
    {{#if equippedEquipment.length}}
      <div class="hwfwm-treasure-list">
        {{#each equippedEquipment as |it|}}
          <div class="hwfwm-treasure-row">
            <div class="hwfwm-treasure-name">{{it.name}}</div>
            <div class="hwfwm-treasure-meta">Type: {{it.category}}</div>
            <div class="hwfwm-itemlist__actions">
              <button type="button" class="hwfwm-itembtn" data-action="open-item" data-item-id="{{it.id}}">Edit</button>
              <button type="button" class="hwfwm-itembtn hwfwm-itembtn--danger" data-action="delete-item" data-item-id="{{it.id}}">Delete</button>
            </div>
          </div>
        {{/each}}
      </div>
    {{else}}
      <div class="hwfwm-muted">No equipped items yet.</div>
    {{/if}}

    {{!-- Readied Consumables (Derived Snapshot) --}}
    <div class="hwfwm-res-separator">Readied Consumables</div>
    {{#if system._derived.consumables.readiedCount}}
      <div class="hwfwm-treasure-list">
        {{#each system._derived.consumables.readiedItems as |it|}}
          <div class="hwfwm-treasure-row">
            <div class="hwfwm-treasure-name">{{it.name}}</div>

            <div class="hwfwm-treasure-meta">
              {{#if it.quantity}}Qty: {{it.quantity}}{{/if}}
              {{#if it.category}}&nbsp;|&nbsp;Cat: {{it.category}}{{/if}}
              {{#if it.itemRank}}&nbsp;|&nbsp;Rank: {{it.itemRank}}{{/if}}
              {{#if it.actionCost}}&nbsp;|&nbsp;AC: {{it.actionCost}}{{/if}}
            </div>

            <div class="hwfwm-itemlist__actions">
              <button type="button" class="hwfwm-itembtn" data-action="open-item" data-item-id="{{it.id}}">Edit</button>
              <button type="button" class="hwfwm-itembtn hwfwm-itembtn--danger" data-action="delete-item" data-item-id="{{it.id}}">Delete</button>
            </div>
          </div>
        {{/each}}
      </div>
    {{else}}
      <div class="hwfwm-muted">No readied consumables yet.</div>
    {{/if}}
  </section>

  {{!-- INVENTORY SUBTAB: manage ALL equipment/consumables + misc actor-data --}}
  <section class="tab" data-group="treasures" data-tab="inventory">

    <div class="hwfwm-treasure-actions">
      <button type="button" class="hwfwm-itembtn" data-action="add-misc-item">Add Misc Item</button>
    </div>

    <div class="hwfwm-res-separator">Equipment</div>

    {{#if allEquipment.length}}
      <div class="hwfwm-treasure-table">
        <div class="hwfwm-treasure-head">
          <div>Name</div>
          <div>Type</div>
          <div>Equipped</div>
          <div></div>
        </div>

        {{#each allEquipment as |it|}}
          <div class="hwfwm-treasure-line">
            <input
              type="text"
              value="{{it.name}}"
              data-item-id="{{it.id}}"
              data-item-field="name"
            />

            {{!-- IMPORTANT: equipment uses system.type (weapon|armor|misc) --}}
            <select data-item-id="{{it.id}}" data-item-field="system.type">
              <option value="weapon" {{#if (eq it.category "weapon")}}selected{{/if}}>Weapon</option>
              <option value="armor" {{#if (eq it.category "armor")}}selected{{/if}}>Armor</option>
              <option value="misc" {{#if (eq it.category "misc")}}selected{{/if}}>Misc</option>
            </select>

            {{!-- IMPORTANT: equipped is boolean --}}
            <label style="display:flex; align-items:center; justify-content:center; gap:8px;">
              <input
                type="checkbox"
                data-bool="true"
                data-item-id="{{it.id}}"
                data-item-field="system.equipped"
                {{#if it.equipped}}checked{{/if}}
              />
              <span class="hwfwm-muted">Equipped</span>
            </label>

            <div class="hwfwm-itemlist__actions">
              <button type="button" class="hwfwm-itembtn" data-action="open-item" data-item-id="{{it.id}}">Edit</button>
              <button type="button" class="hwfwm-itembtn hwfwm-itembtn--danger" data-action="delete-item" data-item-id="{{it.id}}">Delete</button>
            </div>
          </div>
        {{/each}}
      </div>
    {{else}}
      <div class="hwfwm-muted">No equipment in inventory yet.</div>
    {{/if}}

    <div class="hwfwm-res-separator">Consumables</div>

    {{#if allConsumables.length}}
      <div class="hwfwm-treasure-table">
        <div class="hwfwm-treasure-head">
          <div>Name</div>
          <div>Qty</div>
          <div>Readied</div>
          <div></div>
        </div>

        {{#each allConsumables as |it|}}
          <div class="hwfwm-treasure-line">
            <input
              type="text"
              value="{{it.name}}"
              data-item-id="{{it.id}}"
              data-item-field="name"
            />

            <input
              type="number"
              min="0"
              step="1"
              value="{{it.quantity}}"
              data-item-id="{{it.id}}"
              data-item-field="system.quantity"
            />

            {{!-- IMPORTANT: readied is boolean --}}
            <label style="display:flex; align-items:center; justify-content:center; gap:8px;">
              <input
                type="checkbox"
                data-bool="true"
                data-item-id="{{it.id}}"
                data-item-field="system.readied"
                {{#if it.readied}}checked{{/if}}
              />
              <span class="hwfwm-muted">Readied</span>
            </label>

            <div class="hwfwm-itemlist__actions">
              <button type="button" class="hwfwm-itembtn" data-action="open-item" data-item-id="{{it.id}}">Edit</button>
              <button type="button" class="hwfwm-itembtn hwfwm-itembtn--danger" data-action="delete-item" data-item-id="{{it.id}}">Delete</button>
            </div>
          </div>
        {{/each}}
      </div>
    {{else}}
      <div class="hwfwm-muted">No consumables in inventory yet.</div>
    {{/if}}

    <div class="hwfwm-res-separator">Misc Items</div>

    {{#if allMiscItems.length}}
      <div class="hwfwm-treasure-table">
        <div class="hwfwm-treasure-head">
          <div>Name</div>
          <div>Qty</div>
          <div>Notes</div>
          <div></div>
        </div>

        {{#each allMiscItems as |m|}}
          <div class="hwfwm-treasure-line">
            <input
              type="text"
              value="{{m.name}}"
              data-misc-key="{{m.key}}"
              data-misc-field="name"
            />

            <input
              type="number"
              min="0"
              step="1"
              value="{{m.quantity}}"
              data-misc-key="{{m.key}}"
              data-misc-field="quantity"
            />

            <input
              type="text"
              value="{{m.notes}}"
              data-misc-key="{{m.key}}"
              data-misc-field="notes"
            />

            <div class="hwfwm-itemlist__actions">
              <button
                type="button"
                class="hwfwm-itembtn hwfwm-itembtn--danger"
                data-action="remove-misc-item"
                data-key="{{m.key}}"
              >
                Remove
              </button>
            </div>
          </div>
        {{/each}}
      </div>
    {{else}}
      <div class="hwfwm-muted">No misc items yet.</div>
    {{/if}}

  </section>
</div>
