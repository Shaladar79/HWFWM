<div class="hwfwm-card">
  <div class="hwfwm-card__title">Spirit Coins</div>

  {{!-- One-row, 6-across coins --}}
  <div class="hwfwm-coin-row6">
    <div class="hwfwm-coin-cell">
      <div class="hwfwm-res-label">Lesser</div>
      <input class="hwfwm-coin-input" type="number" name="system.treasures.coins.lesser" value="{{system.treasures.coins.lesser}}" min="0" step="1" />
    </div>

    <div class="hwfwm-coin-cell">
      <div class="hwfwm-res-label">Iron</div>
      <input class="hwfwm-coin-input" type="number" name="system.treasures.coins.iron" value="{{system.treasures.coins.iron}}" min="0" step="1" />
    </div>

    <div class="hwfwm-coin-cell">
      <div class="hwfwm-res-label">Bronze</div>
      <input class="hwfwm-coin-input" type="number" name="system.treasures.coins.bronze" value="{{system.treasures.coins.bronze}}" min="0" step="1" />
    </div>

    <div class="hwfwm-coin-cell">
      <div class="hwfwm-res-label">Silver</div>
      <input class="hwfwm-coin-input" type="number" name="system.treasures.coins.silver" value="{{system.treasures.coins.silver}}" min="0" step="1" />
    </div>

    <div class="hwfwm-coin-cell">
      <div class="hwfwm-res-label">Gold</div>
      <input class="hwfwm-coin-input" type="number" name="system.treasures.coins.gold" value="{{system.treasures.coins.gold}}" min="0" step="1" />
    </div>

    <div class="hwfwm-coin-cell">
      <div class="hwfwm-res-label">Diamond</div>
      <input class="hwfwm-coin-input" type="number" name="system.treasures.coins.diamond" value="{{system.treasures.coins.diamond}}" min="0" step="1" />
    </div>
  </div>

  {{!-- Subtabs always below coins --}}
  <nav class="hwfwm-tabs hwfwm-tabs--sub" data-group="treasures">
    <a class="hwfwm-tab {{#if (or (eq system._ui.treasuresSubTab "equipment") (not system._ui.treasuresSubTab))}}is-active{{/if}}" data-tab="equipment">Equipment</a>
    <a class="hwfwm-tab {{#if (eq system._ui.treasuresSubTab "inventory")}}is-active{{/if}}" data-tab="inventory">Inventory</a>
  </nav>

  {{!-- EQUIPMENT SUBTAB: shows only equipped equipment + readied consumables (derived, not duplicated) --}}
  <section class="tab" data-group="treasures" data-tab="equipment">

    {{!-- Equipped Equipment --}}
    <div class="hwfwm-res-separator">Equipped Equipment</div>
    {{#if equippedEquipment.length}}
      <div class="hwfwm-treasure-list">
        {{#each equippedEquipment as |it|}}
          <div class="hwfwm-treasure-row">
            <div class="hwfwm-treasure-name">{{it.name}}</div>
            <div class="hwfwm-treasure-meta">Type: {{it.category}}</div>
            <div class="hwfwm-itemlist__actions">
              <button type="button" class="hwfwm-itembtn" data-action="open-item" data-item-id="{{it.id}}">Edit</button>
              <button type="button" class="hwfwm-itembtn hwfwm-itembtn--danger" data-action="delete-item" data-item-id="{{it.id}}">Delete</button>
            </div>
          </div>
        {{/each}}
      </div>
    {{else}}
      <div class="hwfwm-muted">No equipped items yet.</div>
    {{/if}}

    {{!-- Readied Consumables (Derived Snapshot) --}}
    <div class="hwfwm-res-separator">Readied Consumables</div>
    {{#if system._derived.consumables.readiedCount}}
      <div class="hwfwm-treasure-list">
        {{#each system._derived.consumables.readiedItems as |it|}}
          <div class="hwfwm-treasure-row">
            <div class="hwfwm-treasure-name">{{it.name}}</div>

            <div class="hwfwm-treasure-meta">
              {{#if it.quantity}}Qty: {{it.quantity}}{{/if}}
              {{#if it.category}}&nbsp;|&nbsp;Cat: {{it.category}}{{/if}}
              {{#if it.itemRank}}&nbsp;|&nbsp;Rank: {{it.itemRank}}{{/if}}
              {{#if it.actionCost}}&nbsp;|&nbsp;AC: {{it.actionCost}}{{/if}}
            </div>

            <div class="hwfwm-itemlist__actions">
              <button type="button" class="hwfwm-itembtn" data-action="open-item" data-item-id="{{it.id}}">Edit</button>
              <button type="button" class="hwfwm-itembtn hwfwm-itembtn--danger" data-action="delete-item" data-item-id="{{it.id}}">Delete</button>
            </div>
          </div>
        {{/each}}
      </div>
    {{else}}
      <div class="hwfwm-muted">No readied consumables yet.</div>
    {{/if}}
  </section>

  {{!-- INVENTORY SUBTAB: manage ALL equipment/consumables + misc actor-data --}}
  <section class="tab" data-group="treasures" data-tab="inventory">

    <div class="hwfwm-res-separator">Equipment</div>

    {{#if allEquipment.length}}
      <div class="hwfwm-treasure-table">
        <div class="hwfwm-treasure-head">
          <div>Name</div>
          <div>Type</div>
          <div>Equipped</div>
          <div></div>
        </div>

        {{#each allEquipment as |it|}}
          <div class="hwfwm-treasure-line">
            <input
              type="text"
              value="{{it.name}}"
              data-item-id="{{it.id}}"
              data-item-field="name"
            />

            {{!-- IMPORTANT: equipment uses system.type (weapon|armor|misc) --}}
            <select data-item-id="{{it.id}}" data-item-field="system.type">
              <option value="weapon" {{#if (eq it.category "weapon")}}selected{{/if}}>Weapon</option>
              <option value="armor" {{#if (eq it.category "armor")}}selected{{/if}}>Armor</option>
              <option value="misc" {{#if (eq it.category "misc")}}selected{{/if}}>Misc</option>
            </select>

            {{!-- IMPORTANT: equipped is boolean --}}
            <label style="display:flex; align-items:center; justify-content:center; gap:8px;">
              <input
                type="checkbox"
                data-bool="true"
                data-item-id="{{it.id}}"
                data-item-field="system.equipped"
                {{#if it.equipped}}checked{{/if}}
              />
              <span class="hwfwm-muted">Equipped</span>
            </label>

            <div class="hwfwm-itemlist__actions">
              <button type="button" class="hwfwm-itembtn" data-action="open-item" data-item-id="{{it.id}}">Edit</button>
              <button type="button" class="hwfwm-itembtn hwfwm-itembtn--danger" data-action="delete-item" data-item-id="{{it.id}}">Delete</button>
            </div>
          </div>
        {{/each}}
      </div>
    {{else}}
      <div class="hwfwm-muted">No equipment in inventory yet.</div>
    {{/if}}

    <div class="hwfwm-res-separator">Consumables</div>

    {{#if allConsumables.length}}
      <div class="hwfwm-treasure-table">
        <div class="hwfwm-treasure-head">
          <div>Name</div>
          <div>Qty</div>
          <div>Readied</div>
          <div></div>
        </div>

        {{#each allConsumables as |it|}}
          <div class="hwfwm-treasure-line">
            <input
              type="text"
              value="{{it.name}}"
              data-item-id="{{it.id}}"
              data-item-field="name"
            />

            <input
              type="number"
              min="0"
              step="1"
              value="{{it.quantity}}"
              data-item-id="{{it.id}}"
              data-item-field="system.quantity"
            />

            {{!-- IMPORTANT: readied is boolean --}}
            <label style="display:flex; align-items:center; justify-content:center; gap:8px;">
              <input
                type="checkbox"
                data-bool="true"
                data-item-id="{{it.id}}"
                data-item-field="system.readied"
                {{#if it.readied}}checked{{/if}}
              />
              <span class="hwfwm-muted">Readied</span>
            </label>

            <div class="hwfwm-itemlist__actions">
              <button type="button" class="hwfwm-itembtn" data-action="open-item" data-item-id="{{it.id}}">Edit</button>
              <button type="button" class="hwfwm-itembtn hwfwm-itembtn--danger" data-action="delete-item" data-item-id="{{it.id}}">Delete</button>
            </div>
          </div>
        {{/each}}
      </div>
    {{else}}
      <div class="hwfwm-muted">No consumables in inventory yet.</div>
    {{/if}}

    <div class="hwfwm-res-separator">Misc Items</div>

    {{!-- Inline Add Row (replaces dialog) --}}
    <div class="hwfwm-treasure-actions">
      <div class="hwfwm-treasure-line hwfwm-misc-add-row" style="grid-template-columns: 1fr 2fr 0.8fr auto;">
        {{!-- Category --}}
        <select class="hwfwm-misc-add-category" data-misc-add-field="category" title="Category">
          {{!-- NOTE: context must provide miscAddCategoryOptions: [{value,label}] --}}
          {{#each miscAddCategoryOptions as |o|}}
            <option value="{{o.value}}" {{#if (eq o.value ../miscAddCategorySelected)}}selected{{/if}}>{{o.label}}</option>
          {{/each}}
        </select>

        {{!-- Item (filtered by category) --}}
        <select class="hwfwm-misc-add-key" data-misc-add-field="key" title="Item">
          {{!-- NOTE: context must provide miscAddItemOptions: [{value,label}] --}}
          <option value="">— Select —</option>
          {{#each miscAddItemOptions as |o|}}
            <option value="{{o.value}}">{{o.label}}</option>
          {{/each}}
        </select>

        {{!-- Quantity --}}
        <input
          class="hwfwm-misc-add-qty"
          data-misc-add-field="qty"
          type="number"
          min="1"
          step="1"
          value="1"
          title="Quantity"
        />

        <div class="hwfwm-itemlist__actions" style="justify-content:flex-end;">
          <button type="button" class="hwfwm-itembtn" data-action="misc-add-row">Add</button>
        </div>
      </div>
    </div>

    {{#if allMiscItems.length}}
      <div class="hwfwm-treasure-table">
        <div class="hwfwm-treasure-head">
          <div>Name</div>
          <div>Category</div>
          <div>Qty</div>
          <div>Equipped</div>
          <div>Rank</div>
          <div>Weight</div>
          <div>Value</div>
          <div>Notes</div>
          <div></div>
        </div>

        {{#each allMiscItems as |m|}}
          <div class="hwfwm-treasure-line">
            <input
              type="text"
              value="{{m.name}}"
              data-misc-key="{{m.key}}"
              data-misc-field="name"
              title="{{#if m.missingFromCatalog}}Missing from catalog (key: {{m.key}}){{/if}}"
            />

            {{!-- Catalog-driven, read-only --}}
            <input
              type="text"
              value="{{m.category}}"
              readonly
              tabindex="-1"
              title="{{#if m.missingFromCatalog}}Missing from catalog (key: {{m.key}}){{/if}}"
            />

            <input
              type="number"
              min="0"
              step="1"
              value="{{m.quantity}}"
              data-misc-key="{{m.key}}"
              data-misc-field="quantity"
            />

            {{!-- Per-actor --}}
            <label style="display:flex; align-items:center; justify-content:center; gap:8px;">
              <input
                type="checkbox"
                data-bool="true"
                data-misc-key="{{m.key}}"
                data-misc-field="equipped"
                {{#if m.equipped}}checked{{/if}}
              />
            </label>

            <input
              type="text"
              value="{{m.rank}}"
              placeholder="—"
              data-misc-key="{{m.key}}"
              data-misc-field="rank"
            />

            {{!-- Editable override; blank = use catalog/base --}}
            <input
              type="number"
              min="0"
              step="0.01"
              value="{{#if (ne m.weightOverride null)}}{{m.weightOverride}}{{/if}}"
              placeholder="{{m.weight}}"
              data-misc-key="{{m.key}}"
              data-misc-field="weight"
              title="Blank uses catalog/base (currently: {{m.weight}})"
            />

            {{!-- Editable override; blank = use catalog/base --}}
            <input
              type="number"
              min="0"
              step="1"
              value="{{#if (ne m.valueOverride null)}}{{m.valueOverride}}{{/if}}"
              placeholder="{{m.value}}"
              data-misc-key="{{m.key}}"
              data-misc-field="value"
              title="Blank uses catalog/base (currently: {{m.value}})"
            />

            <input
              type="text"
              value="{{m.notes}}"
              data-misc-key="{{m.key}}"
              data-misc-field="notes"
              placeholder="{{#if m.description}}{{m.description}}{{else}}Notes…{{/if}}"
              title="{{#if m.description}}{{m.description}}{{/if}}"
            />

            <div class="hwfwm-itemlist__actions">
              <button
                type="button"
                class="hwfwm-itembtn"
                data-action="remove-misc-qty"
                data-key="{{m.key}}"
                title="Remove a quantity from this row"
              >
                Remove Qty…
              </button>

              <button
                type="button"
                class="hwfwm-itembtn hwfwm-itembtn--danger"
                data-action="remove-misc-item"
                data-key="{{m.key}}"
                title="Remove the row entirely"
              >
                Remove All
              </button>
            </div>
          </div>
        {{/each}}
      </div>

      <div class="hwfwm-muted" style="margin-top: 6px;">
        Weight/Value: leave blank to use catalog defaults. If a catalog entry is removed or renamed, the row remains editable but may show missing metadata.
      </div>
    {{else}}
      <div class="hwfwm-muted">No misc items yet.</div>
    {{/if}}

  </section>
</div>
