{{!-- templates/actor/tabs/treasures/misc.hbs --}}

<div class="hwfwm-res-separator">Misc Items</div>

{{!-- Inline Add Row (binder populates both category + item list from catalog) --}}
<div class="hwfwm-treasure-actions">
  <div class="hwfwm-treasure-line hwfwm-misc-add-row" style="grid-template-columns: 1fr 2fr 0.8fr auto;">
    {{!-- Category (options built by listeners.mjs from catalog groups) --}}
    <select class="hwfwm-misc-add-group" data-misc-add-field="category" title="Category">
      <option value="">— Loading —</option>
    </select>

    {{!-- Item (filtered by category) --}}
    <select class="hwfwm-misc-add-key" data-misc-add-field="key" title="Item">
      <option value="">— Select —</option>
    </select>

    {{!-- Quantity --}}
    <input
      class="hwfwm-misc-add-qty"
      data-misc-add-field="qty"
      type="number"
      min="1"
      step="1"
      value="1"
      title="Quantity"
    />

    <div class="hwfwm-itemlist__actions" style="justify-content:flex-end;">
      <button type="button" class="hwfwm-itembtn" data-action="misc-add-row">Add</button>
    </div>
  </div>
</div>

{{#if allMiscItems.length}}
  <div class="hwfwm-treasure-table">
    <div class="hwfwm-treasure-head">
      <div>Name</div>
      <div>Category</div>
      <div>Qty</div>
      <div>Rank</div>
      <div>Value</div>
      <div></div>
    </div>

    {{#each allMiscItems as |m|}}
      <div class="hwfwm-treasure-line">
        {{!-- Name is display-only; stored name is only a fallback cache --}}
        <input
          type="text"
          value="{{m.name}}"
          readonly
          tabindex="-1"
          title="{{#if m.missingFromCatalog}}Missing from catalog (key: {{m.key}}){{/if}}"
        />

        {{!-- Category is catalog-driven, read-only --}}
        <input
          type="text"
          value="{{m.category}}"
          readonly
          tabindex="-1"
          title="{{#if m.missingFromCatalog}}Missing from catalog (key: {{m.key}}){{/if}}"
        />

        {{!-- Quantity is the primary editable field --}}
        <input
          type="number"
          min="0"
          step="1"
          value="{{m.quantity}}"
          data-misc-key="{{m.key}}"
          data-misc-field="quantity"
        />

        {{!-- Rank only when applicable --}}
        {{#if m.hasRank}}
          <input
            type="text"
            value="{{m.rank}}"
            placeholder="—"
            data-misc-key="{{m.key}}"
            data-misc-field="rank"
            title="Rank (only for ranked misc types)"
          />
        {{else}}
          <div class="hwfwm-muted" style="display:flex; align-items:center;">—</div>
        {{/if}}

        {{!-- Value is derived from rarity rules + base numeric value --}}
        <div style="display:flex; flex-direction:column; gap:2px;">
          <input
            type="text"
            value="{{m.displayValue}}"
            readonly
            tabindex="-1"
            title="Per-unit value (derived)"
          />
          {{#if m.totalValue}}
            <div class="hwfwm-muted" style="font-size: 11px; line-height: 1.1;">
              Total: {{m.totalValue}}
            </div>
          {{/if}}
        </div>

        <div class="hwfwm-itemlist__actions">
          <button
            type="button"
            class="hwfwm-itembtn"
            data-action="remove-misc-qty"
            data-key="{{m.key}}"
            title="Remove a quantity from this row"
          >
            Remove Qty…
          </button>

          <button
            type="button"
            class="hwfwm-itembtn hwfwm-itembtn--danger"
            data-action="remove-misc-item"
            data-key="{{m.key}}"
            title="Remove the row entirely"
          >
            Remove All
          </button>
        </div>
      </div>
    {{/each}}
  </div>
{{else}}
  <div class="hwfwm-muted">No misc items yet.</div>
{{/if}}
